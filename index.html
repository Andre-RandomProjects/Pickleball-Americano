<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PickleBall</title>
<style>
body { font-family: Arial, sans-serif; background: #f4f6f8; padding: 15px; margin: 0; }
.container { max-width: 1000px; margin: auto; }
h2 { margin-top: 0; }
label { font-weight: bold; display: block; margin-top: 12px; }
textarea, input, select { font-size: 16px; width: 100%; box-sizing: border-box; margin-top: 6px; }
textarea { height: 160px; }
input[type="number"] { max-width: 120px; }
.button-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
button { padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; min-width: 160px; }
.generate-btn { background: #1976d2; color: white; }
.reset-btn { background: #e53935; color: white; }
.round { background: white; border-radius: 10px; padding: 15px; margin-top: 18px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
.round.completed { opacity: 0.6; }
.round-header { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; padding-bottom: 6px; }
.round-header h3 { margin: 0; }
.complete-toggle { margin-left: auto; display: flex; align-items: center; gap: 6px; font-size: 14px; white-space: nowrap; }
.courts { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 10px; }
.court { background: #f9fafb; border-radius: 8px; padding: 10px; border: 1px solid #e3e6ea; text-align: center; }
.court-title { font-weight: bold; margin-bottom: 6px; }
.team { background: #eaf2ff; padding: 6px; border-radius: 6px; margin: 4px 0; }
.vs { font-weight: bold; margin: 4px 0; }
.score-inputs { display: flex; justify-content: center; gap: 6px; margin-top: 6px; }
.score-inputs input { width: 50px; text-align: center; font-weight: bold; }
.sitout { margin-top: 10px; font-style: italic; color: #666; }
.rankings { background: white; border-radius: 10px; padding: 15px; margin-top: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
.rankings table { width: 100%; border-collapse: collapse; }
.rankings th, .rankings td { padding: 8px; border-bottom: 1px solid #eee; text-align: left; }
.rankings th { background: #f1f3f5; }
@media (min-width: 700px) { .courts { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); } }
</style>
</head>
<body>
<div class="container">
<h2>PickleBall</h2>

<label>Match Type</label>
<select id="mode" onchange="switchMode()">
  <option value="doubles">Singles or Teams</option>
  <option value="mixed">Doubles (Americano Single Entry)</option>
</select>

<label id="playerLabel">Enter player names or teams (one entry per line)</label>
<textarea id="players"></textarea>

<label>Number of courts</label>
<input type="number" id="courts" value="2">

<div class="button-row">
  <button class="generate-btn" onclick="confirmGenerate()">Generate</button>
  <button class="reset-btn" onclick="resetApp()">Reset</button>
</div>

<div id="output"></div>
</div>

<script>
let matchesData = [];

// Update label and clear rounds when switching mode
function switchMode(){
  const mode = document.getElementById("mode").value;
  const label = document.getElementById("playerLabel");
  label.textContent = mode === "doubles" ?
    "Enter player names or teams (one entry per line)" :
    "Enter players (one entry per line)";
  
  // Clear existing rounds when switching
  document.getElementById("output").innerHTML="";
  matchesData=[];
}

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

function confirmGenerate(){
  if(document.getElementById("output").children.length &&
     !confirm("Generate a new schedule and clear current data?")) return;
  generate();
}

function resetApp(){
  if(!confirm("Reset everything?")) return;
  document.getElementById("players").value="";
  document.getElementById("courts").value=2;
  document.getElementById("output").innerHTML="";
  matchesData=[];
}

function toggleRoundDone(cb){ cb.closest(".round").classList.toggle("completed", cb.checked); }

function generateAllPairs(teams){
  const pairs = [];
  for(let i=0;i<teams.length;i++){
    for(let j=i+1;j<teams.length;j++){
      pairs.push([teams[i], teams[j]]);
    }
  }
  shuffle(pairs);
  return pairs;
}

// Scheduler for Singles/Teams
function generateSinglesTeamsRounds(teams, courts){
  const allPairs = generateAllPairs(teams);
  const rounds = [];
  let remainingPairs = [...allPairs];

  while(remainingPairs.length){
    const roundPairs = [];
    const teamsInRound = new Set();

    for(let i=0;i<remainingPairs.length;i++){
      const [a,b] = remainingPairs[i];
      if(!teamsInRound.has(a) && !teamsInRound.has(b)){
        roundPairs.push([a,b]);
        teamsInRound.add(a); teamsInRound.add(b);
      }
      if(roundPairs.length >= courts) break;
    }

    // Remove assigned matches
    remainingPairs = remainingPairs.filter(p => !roundPairs.some(rp => (rp[0]===p[0]&&rp[1]===p[1]) || (rp[0]===p[1]&&rp[1]===p[0])));

    // Sit-outs
    const sitOut = teams.filter(t=>!teamsInRound.has(t));

    rounds.push({pairs: roundPairs, sitOut});
  }

  return rounds;
}

// Americano random doubles
function generateAmericanoRounds(players, courts){
  const rounds = [];
  const maxPlayers = courts*4;
  let sitQueue = [...players];
  shuffle(sitQueue);

  const totalRounds = players.length; // loop entries.length times
  for(let r=0;r<totalRounds;r++){
    let sitOut = sitQueue.splice(0, Math.max(0, sitQueue.length-maxPlayers));
    let active = players.filter(p=>!sitOut.includes(p));
    shuffle(active);
    const pairs = [];
    for(let c=0;c<courts;c++){
      const slice = active.slice(c*4,c*4+4);
      if(slice.length<4) break;
      pairs.push({teamA:[slice[0],slice[2]], teamB:[slice[1],slice[3]]});
    }
    rounds.push({pairs, sitOut});
    sitQueue.push(...sitOut);
  }
  return rounds;
}

function generate(){
  const courts = parseInt(document.getElementById("courts").value);
  const mode = document.getElementById("mode").value;
  const entries = document.getElementById("players").value.split("\n").map(p=>p.trim()).filter(Boolean);

  if(mode==="doubles" && entries.length<2){ alert("At least 2 teams needed"); return; }
  if(mode==="mixed" && entries.length<4){ alert("At least 4 players needed"); return; }

  matchesData=[];
  document.getElementById("output").innerHTML="";

  if(mode==="doubles"){
    const rounds = generateSinglesTeamsRounds(entries, courts);
    rounds.forEach((r,idx)=>{
      const round=document.createElement("div");
      round.className="round";
      round.innerHTML=`<div class="round-header"><h3>Round ${idx+1}</h3>
        <label class="complete-toggle"><input type="checkbox" onchange="toggleRoundDone(this)"> Done</label></div>`;
      const courtsDiv=document.createElement("div");
      courtsDiv.className="courts";

      r.pairs.forEach((p,cIdx)=>{
        const matchIndex = matchesData.length;
        matchesData.push({teamA:p[0].split("&").map(x=>x.trim()), teamB:p[1].split("&").map(x=>x.trim()), scoreA:0, scoreB:0});
        courtsDiv.innerHTML+=`
          <div class="court">
            <div class="court-title">Court ${cIdx+1}</div>
            <div class="team">${p[0]}</div>
            <div class="vs">VS</div>
            <div class="team">${p[1]}</div>
            <div class="score-inputs">
              <input type="number" min="0" value="0" onchange="updateScore(${matchIndex},'A',this.value)">
              <span>:</span>
              <input type="number" min="0" value="0" onchange="updateScore(${matchIndex},'B',this.value)">
            </div>
          </div>`;
      });

      if(r.sitOut.length) round.innerHTML+=`<div class="sitout"><strong>Sit out:</strong> ${r.sitOut.join(", ")}</div>`;
      round.appendChild(courtsDiv);
      document.getElementById("output").appendChild(round);
    });

    document.getElementById("output").insertAdjacentHTML("beforeend",
      `<div style="margin-top:20px;"><button class="generate-btn" onclick="showRankings()">Show Final Rankings</button></div>`);

  } else {
    const rounds = generateAmericanoRounds(entries, courts);
    rounds.forEach((r,idx)=>{
      const round=document.createElement("div");
      round.className="round";
      round.innerHTML=`<div class="round-header"><h3>Round ${idx+1}</h3>
        <label class="complete-toggle"><input type="checkbox" onchange="toggleRoundDone(this)"> Done</label></div>`;
      const courtsDiv=document.createElement("div");
      courtsDiv.className="courts";
      r.pairs.forEach((p,cIdx)=>{
        matchesData.push({teamA:p.teamA, teamB:p.teamB});
        courtsDiv.innerHTML+=`
          <div class="court">
            <div class="court-title">Court ${cIdx+1}</div>
            <div class="team">${p.teamA.join(" & ")}</div>
            <div class="vs">VS</div>
            <div class="team">${p.teamB.join(" & ")}</div>
          </div>`;
      });
      if(r.sitOut.length) round.innerHTML+=`<div class="sitout"><strong>Sit out:</strong> ${r.sitOut.join(", ")}</div>`;
      round.appendChild(courtsDiv);
      document.getElementById("output").appendChild(round);
    });
  }
}

function updateScore(index,side,value){ matchesData[index][side==='A'?'scoreA':'scoreB']=parseInt(value)||0; }

function showRankings(){
  const stats={};
  matchesData.forEach(m=>{
    const keyA=m.teamA.join(" & "), keyB=m.teamB.join(" & ");
    stats[keyA]??={wins:0,games:0};
    stats[keyB]??={wins:0,games:0};
    stats[keyA].games+=m.scoreA||0; stats[keyB].games+=m.scoreB||0;
    if(m.scoreA>m.scoreB) stats[keyA].wins++; else if(m.scoreB>m.scoreA) stats[keyB].wins++;
  });
  const ranking=Object.entries(stats).sort((a,b)=>b[1].wins-a[1].wins || b[1].games-a[1].games);
  let html=`<div class="rankings"><h3>üèÜ Final Rankings</h3><table><tr><th>Rank</th><th>Team</th><th>Wins</th><th>Games</th></tr>`;
  ranking.forEach(([team,s],i)=>{ html+=`<tr><td>${i+1}</td><td>${team}</td><td>${s.wins}</td><td>${s.games}</td></tr>`; });
  html+=`</table></div>`;
  document.getElementById("output").insertAdjacentHTML("beforeend",html);
}

updateLabel();
</script>
</body>
</html>
