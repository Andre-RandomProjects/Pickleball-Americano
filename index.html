<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PickleBall Scheduler</title>
<style>
body { font-family: Arial,sans-serif; background:#f4f6f8; padding:15px; }
.container { max-width:1100px; margin:auto; }
label { font-weight:bold; display:block; margin-top:12px; }
textarea,input,select { width:100%; margin-top:6px; padding:8px; font-size:16px; }
textarea { height:150px; }
.button-row { display:flex; gap:10px; margin-top:12px; }
button { padding:12px; border:none; border-radius:6px; font-size:16px; font-weight:bold; cursor:pointer; }
.generate { background:#1976d2; color:#fff; }
.reset { background:#d32f2f; color:#fff; }

.warning { background:#fff3cd; border:1px solid #ffeeba; border-radius:6px; padding:12px; margin-top:14px; color:#856404; font-weight:bold; }

.round { background:#fff; border-radius:10px; padding:15px; margin-top:18px; box-shadow:0 4px 10px rgba(0,0,0,.08); }
.round-header { display:flex; justify-content:space-between; border-bottom:1px solid #eee; font-weight:bold; }

.courts { display:grid; gap:10px; margin-top:10px; }
@media(min-width:700px){ .courts { grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); } }

.court { background:#f9fafb; border:1px solid #e3e6ea; border-radius:8px; padding:10px; text-align:center; }
.court-title { font-weight:bold; margin-bottom:6px; }
.vs { font-weight:bold; line-height:1.4; }

.sitout { margin-top:10px; font-style:italic; color:#555; }

.tabs { display:flex; gap:10px; margin-top:15px; }
.tab { padding:8px 16px; background:#eee; cursor:pointer; border-radius:6px; font-weight:bold; }
.tab.active { background:#1976d2; color:#fff; }
.tab-content { display:none; }
.tab-content.active { display:block; }

table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ddd; padding:6px; text-align:center; }
th { background:#f1f1f1; }

.score-input { width:45px; text-align:center; font-weight:bold; }
</style>
</head>
<body>
<div class="container">
<h2>PickleBall Scheduler</h2>

<label>Match Type</label>
<select id="mode" onchange="clearAll()">
  <option value="teams">Singles / Teams</option>
  <option value="americano">Doubles (Americano)</option>
</select>

<label>Players / Teams (one per line)</label>
<textarea id="entries"></textarea>

<label>Number of courts (max 4)</label>
<input type="number" id="courts" min="1" max="4" value="2">

<div class="button-row">
  <button class="generate" onclick="generate()">Generate</button>
  <button class="reset" onclick="location.reload()">Reset</button>
</div>

<div id="warning"></div>

<div id="teamsTabs" style="display:none;">
  <div class="tabs">
    <div class="tab active" onclick="switchTab('rounds')">Rounds</div>
    <div class="tab" onclick="switchTab('score')">Scoreboard</div>
  </div>
  <div id="rounds" class="tab-content active"></div>
  <div id="score" class="tab-content"></div>
</div>

<div id="americanoOutput"></div>
</div>

<script>
const qs=id=>document.getElementById(id);

function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [array[i],array[j]]=[array[j],array[i]];
  }
}

function clearAll(){
  qs("warning").innerHTML="";
  qs("rounds").innerHTML="";
  qs("score").innerHTML="";
  qs("americanoOutput").innerHTML="";
  qs("teamsTabs").style.display="none";
}

function switchTab(id){
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
  document.querySelectorAll(".tab")[id==="rounds"?0:1].classList.add("active");
  qs(id).classList.add("active");
}

/* Teams round-robin generator */
function generateTeamRounds(teams, courts){
  if(courts>4) courts=4;
  const matches=[];
  for(let i=0;i<teams.length;i++){
    for(let j=i+1;j<teams.length;j++){
      matches.push([teams[i],teams[j]]);
    }
  }
  const rounds=[];
  let availableMatches = [...matches];

  while(availableMatches.length>0){
    const roundMatches=[];
    const usedTeams = new Set();
    for(let i=0;i<availableMatches.length && roundMatches.length<courts;i++){
      const [a,b] = availableMatches[i];
      if(!usedTeams.has(a) && !usedTeams.has(b)){
        roundMatches.push([a,b]);
        usedTeams.add(a);
        usedTeams.add(b);
      }
    }
    roundMatches.forEach(m=>{
      const idx=availableMatches.findIndex(x=>x[0]===m[0] && x[1]===m[1]);
      if(idx!==-1) availableMatches.splice(idx,1);
    });
    while(roundMatches.length<courts && availableMatches.length>0){
      roundMatches.push(availableMatches.shift());
    }
    const roundTeams = roundMatches.flat();
    const sitOut = teams.filter(t=>!roundTeams.includes(t));
    rounds.push({matches:roundMatches,sitOut});
  }

  return rounds;
}

/* Americano proper combinatorial scheduler */
function generateAmericanoRounds(players,courts){
  if(players.length<4) return [];
  const totalRounds = Math.ceil(180/10);
  const rounds=[];
  const pairTracker = {};
  const sitCount = new Map();
  players.forEach(p=>sitCount.set(p,0));

  // generate all pairs
  for(let i=0;i<players.length;i++){
    for(let j=i+1;j<players.length;j++){
      pairTracker[[players[i],players[j]].sort().join("|")]=0;
    }
  }

  function getAllPairs(subset){
    const res=[];
    for(let i=0;i<subset.length;i++){
      for(let j=i+1;j<subset.length;j++){
        res.push([subset[i],subset[j]].sort().join("|"));
      }
    }
    return res;
  }

  for(let r=0;r<totalRounds;r++){
    const slots = courts*4;
    const minSit = Math.min(...Array.from(sitCount.values()));
    let sitOut = players.filter(p=>sitCount.get(p)===minSit).slice(0,Math.max(0,players.length-slots));
    sitOut.forEach(p=>sitCount.set(p,sitCount.get(p)+1));

    const active = players.filter(p=>!sitOut.includes(p));
    shuffle(active);
    const used = new Set();
    const matches=[];
    for(let c=0;c<courts;c++){
      const remaining = active.filter(p=>!used.has(p));
      if(remaining.length<4) break;
      const subset = remaining.slice(0,4);
      subset.forEach(p=>used.add(p));
      matches.push({A:[subset[0],subset[1]],B:[subset[2],subset[3]]});
      getAllPairs(subset).forEach(pair=>pairTracker[pair]++);
    }
    rounds.push({matches,sit:sitOut});
    if(Object.values(pairTracker).every(v=>v>0)){
      for(let k in pairTracker) pairTracker[k]=0;
    }
  }

  return rounds;
}

/* Generate */
function generate(){
  clearAll();
  let entries=qs("entries").value.split("\n").map(x=>x.trim()).filter(Boolean);
  shuffle(entries);
  let courts=parseInt(qs("courts").value);
  if(courts>4){ courts=4; qs("courts").value=4; }
  const mode=qs("mode").value;

  if(mode==="teams"){
    if(entries.length<2){
      qs("warning").innerHTML=`Not enough teams to fill all courts.<br>
        ${entries.length} teams for ${courts} courts.<br>
        Total teams required: ${Math.min(entries.length,courts*2)}`;
      return;
    }
    qs("teamsTabs").style.display="block";
    const rounds=generateTeamRounds(entries,courts);
    rounds.forEach((r,i)=>renderTeamsRound(i+1,r));
    buildScoreboard(entries);
  }

  if(mode==="americano"){
    if(entries.length<4){
      qs("warning").innerHTML=`Not enough players to fill all courts.<br>
        ${entries.length} players for ${courts} courts.<br>
        Total players required: ${Math.max(4,courts*4)}`;
      return;
    }
    const rounds=generateAmericanoRounds(entries,courts);
    rounds.forEach((r,i)=>renderAmericanoRound(i+1,r));
  }
}

/* Render */
function renderTeamsRound(num,r){
  const round=document.createElement("div");
  round.className="round";
  round.innerHTML=`<div class="round-header">Round ${num}</div>`;
  const courtsDiv=document.createElement("div");
  courtsDiv.className="courts";
  const totalCourts=parseInt(qs("courts").value);

  r.matches.forEach((m,i)=>{
    courtsDiv.innerHTML+=
      `<div class="court">
         <div class="court-title">Court ${i+1}</div>
         <div class="vs">${m[0]} vs ${m[1]}</div>
         <div class="score">
           <input type="number" class="score-input" placeholder="0"> :
           <input type="number" class="score-input" placeholder="0">
         </div>
       </div>`;
  });

  for(let i=r.matches.length;i<totalCourts;i++){
    courtsDiv.innerHTML+=
      `<div class="court" style="background:#ffdddd; color:#a00;">
         <div class="court-title">Court ${i+1}</div>
         <div class="vs">Unused</div>
       </div>`;
  }

  round.appendChild(courtsDiv);
  const sitDiv=document.createElement("div");
  sitDiv.className="sitout";
  sitDiv.innerHTML=`<strong>Sit out:</strong> ${r.sitOut.length>0?r.sitOut.join(", "):"None"}`;
  round.appendChild(sitDiv);
  qs("rounds").appendChild(round);
}

function renderAmericanoRound(num,r){
  const round=document.createElement("div");
  round.className="round";
  round.innerHTML=`<div class="round-header">Round ${num}</div>`;
  const courtsDiv=document.createElement("div");
  courtsDiv.className="courts";
  r.matches.forEach((m,i)=>{
    courtsDiv.innerHTML+=
      `<div class="court">
         <div class="court-title">Court ${i+1}</div>
         <div class="vs">${m.A.join(" & ")}<br>vs<br>${m.B.join(" & ")}</div>
       </div>`;
  });
  round.appendChild(courtsDiv);
  const sitDiv=document.createElement("div");
  sitDiv.className="sitout";
  sitDiv.innerHTML=`<strong>Sit out:</strong> ${r.sit.length>0?r.sit.join(", "):"None"}`;
  round.appendChild(sitDiv);
  qs("americanoOutput").appendChild(round);
}

/* Scoreboard */
function buildScoreboard(players){
  const scoreData = {};
  players.forEach(p=>scoreData[p]={won:0,lost:0,points:0});

  const updateScoreboard = ()=>{
    players.forEach(p=>scoreData[p]={won:0,lost:0,points:0});
    document.querySelectorAll(".round").forEach(round=>{
      const courts = round.querySelectorAll(".court");
      courts.forEach(court=>{
        const vs = court.querySelector(".vs").textContent.trim();
        if(vs.includes("vs") && court.querySelector(".score")){
          const [teamA,teamB] = vs.split(" vs ").map(t=>t.trim());
          const scoreInputs = court.querySelectorAll(".score-input");
          const scoreA = parseInt(scoreInputs[0].value) || 0;
          const scoreB = parseInt(scoreInputs[1].value) || 0;

          scoreData[teamA].points += scoreA;
          scoreData[teamB].points += scoreB;

          if(scoreA>scoreB){ scoreData[teamA].won++; scoreData[teamB].lost++; }
          else if(scoreB>scoreA){ scoreData[teamB].won++; scoreData[teamA].lost++; }
        }
      });
    });

    const sorted = [...players].sort((a,b)=>{
      if(scoreData[b].won !== scoreData[a].won) return scoreData[b].won - scoreData[a].won;
      return scoreData[b].points - scoreData[a].points;
    });

    let html=`<table><tr><th>Team</th><th>Won</th><th>Lost</th><th>Points</th></tr>`;
    sorted.forEach(p=>{
      html+=`<tr data-team="${p}">
        <td>${p}</td>
        <td class="won">${scoreData[p].won}</td>
        <td class="lost">${scoreData[p].lost}</td>
        <td class="points">${scoreData[p].points}</td>
      </tr>`;
    });
    html+=`</table>`;
    qs("score").innerHTML = html;
  };

  document.addEventListener("input",(e)=>{
    if(e.target.classList.contains("score-input")){
      updateScoreboard();
    }
  });

  updateScoreboard();
}
</script>
</body>
</html>
